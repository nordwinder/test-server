name: Update OpenAPI on PR

on:
  push:
    branches: [ "main" ]

jobs:
  openapi:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Determine SDK base branch
        id: sdk-branch
        run: |
          if git ls-remote --exit-code \
            https://github.com/nordwinder/test-server-sdk.git \
            refs/heads/update-openapi > /dev/null 2>&1; then
            echo "branch=update-openapi" >> "$GITHUB_OUTPUT"
          else
            echo "branch=main" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout SDK repo
        uses: actions/checkout@v6
        with:
          repository: nordwinder/test-server-sdk
          ref: ${{ steps.sdk-branch.outputs.branch }}
          path: sdk
          persist-credentials: false

      - name: Copy openapi.yaml
        run: cp openapi.yaml sdk/

      - name: Add changeset file
        working-directory: sdk
        env:
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MSG_RAW: ${{ github.event.head_commit.message }}
        run: |
          if git diff --quiet -- openapi.yaml; then
            echo "OpenAPI spec not changed, skipping changeset"
            exit 0
          fi
          mkdir -p .changeset
          COMMIT_MSG="${COMMIT_MSG_RAW%%$'\n'*}"
          {
            echo '---'
            echo '"@crypticdot/defituna-api": patch'
            echo '---'
            echo
            printf '%s\n' "$COMMIT_MSG"
          } > ".changeset/openapi-${COMMIT_SHA::10}.md"

      - name: Create or update PR
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725
        with:
          token: ${{ secrets.SDK_REPO_TOKEN }}
          path: sdk
          branch: update-openapi
          base: main
          commit-message: "Update OpenAPI specification"
          title: "Update OpenAPI specification"
          body: |
            Automated OpenAPI update from backend.

            Source repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
